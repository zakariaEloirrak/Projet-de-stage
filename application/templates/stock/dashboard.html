{% extends 'base.html' %}
{% load static %}
{% load stock_filters %}

{% block title %}Gestion de Stock - Dashboard{% endblock %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{% block content %}

<link rel="stylesheet" href="{% static 'css/stock/dashboard.css' %}">

<div class="page-header">
    <h1><i class="fas fa-warehouse"></i> Gestion de Stock</h1>
    <div class="breadcrumb">
        <a href="{% url 'dashboard' %}">Dashboard</a>
        <i class="fas fa-chevron-right"></i>
        <span>Stock</span>
    </div>
</div>

<!-- Statistiques principales -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-content">
            <div class="stat-info">
                <h5>Total Produits</h5>
                <h2>{{ total_produits }}</h2>
            </div>
            <div class="stat-icon">
                <i class="fas fa-boxes"></i>
            </div>
        </div>
    </div>
    
    <div class="stat-card warning">
        <div class="stat-content">
            <div class="stat-info">
                <h5>Alertes Stock</h5>
                <h2>{{ produits_alerte }}</h2>
            </div>
            <div class="stat-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
        </div>
    </div>
    
    <div class="stat-card success">
        <div class="stat-content">
            <div class="stat-info">
                <h5>Valeur Stock</h5>
                <h2>{{ valeur_stock|currency }} MAD</h2>
            </div>
            <div class="stat-icon">
                <i class="fas fa-coins"></i>
            </div>
        </div>
    </div>
    
    <div class="stat-card info">
        <div class="stat-content">
            <div class="stat-info">
                <h5>Mouvements Jour</h5>
                <h2>{{ mouvements_jour }}</h2>
            </div>
            <div class="stat-icon">
                <i class="fas fa-exchange-alt"></i>
            </div>
        </div>
    </div>
</div>

<!-- Actions rapides -->
<div class="card">
    <div class="card-header">
        <h5><i class="fas fa-bolt"></i> Actions Rapides</h5>
    </div>
    <div class="card-body">
        <div class="actions-grid">
            <a href="{% url 'ajouter_produit' %}" class="action-card">
                <i class="fas fa-plus"></i>
                <h6>Nouveau Produit</h6>
            </a>
            <a href="{% url 'mouvement_stock_form' %}" class="action-card">
                <i class="fas fa-exchange-alt"></i>
                <h6>Mouvement Stock</h6>
            </a>
            <a href="{% url 'liste_produits' %}" class="action-card">
                <i class="fas fa-list"></i>
                <h6>Liste Produits</h6>
            </a>
            <a href="{% url 'rapport_stock' %}" class="action-card">
                <i class="fas fa-chart-bar"></i>
                <h6>Rapport</h6>
            </a>
        </div>
    </div>
</div>

<div class="content-grid">
    <!-- Graphique des mouvements -->
    <div class="card">
        <div class="card-header flex justify-between align-center">
            <h5><i class="fas fa-chart-line"></i> Mouvements de Stock (7 derniers jours)</h5>
            <select id="periodSelect" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: var(--radius-sm);">
                <option value="7">7 jours</option>
                <option value="15">15 jours</option>
                <option value="30">30 jours</option>
            </select>
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="stockChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Statistiques mouvements et Top produits -->
    <div class="sidebar-stats">
        <div class="sidebar-card">
            <div class="sidebar-header">
                <h5><i class="fas fa-chart-pie"></i> Stats Mouvements (30j)</h5>
            </div>
            <div class="sidebar-body">
                {% for stat in stats_mouvements %}
                <div class="stat-item">
                    <div>
                        <div>{{ stat.get_type_mouvement_display|default:stat.type_mouvement }}</div>
                        <small style="color: var(--text-secondary);">{{ stat.nombre_mouvements }} mouvement{{ stat.nombre_mouvements|pluralize }}</small>
                    </div>
                    <strong>{{ stat.total_quantite|floatformat:1 }}</strong>
                </div>
                {% empty %}
                <p style="color: var(--text-secondary); text-align: center;">Aucun mouvement ce mois</p>
                {% endfor %}
            </div>
        </div>
        
        <!-- Top produits -->
        <div class="sidebar-card">
            <div class="sidebar-header">
                <h5><i class="fas fa-trophy"></i> Top Produits</h5>
            </div>
            <div class="sidebar-body">
                {% for produit in top_produits %}
                <div style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <div>
                            <small style="color: var(--text-secondary);">{{ produit.poisson__code_produit }}</small>
                            <div style="font-weight: 500;">{{ produit.poisson__type }}</div>
                        </div>
                        <small style="color: var(--text-secondary);">{{ produit.total_mouvements|floatformat:1 }}</small>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {% if top_produits.0.total_mouvements %}{{ produit.total_mouvements|percentage:top_produits.0.total_mouvements }}{% else %}0{% endif %}%"></div>
                    </div>
                </div>
                {% empty %}
                <p style="color: var(--text-secondary); text-align: center;">Aucune donnée</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Mouvements récents -->
<div class="card">
    <div class="card-header flex justify-between align-center">
        <h5><i class="fas fa-clock"></i> Mouvements Récents</h5>
        <a href="{% url 'historique_mouvements' %}" class="btn btn-primary btn-sm">
            Voir tout
        </a>
    </div>
    <div class="card-body" style="padding: 0;">
        {% if mouvements_recents %}
        <div style="overflow-x: auto;">
            <table class="movements-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Produit</th>
                        <th>Type</th>
                        <th>Quantité</th>
                        <th>Utilisateur</th>
                        <th>Motif</th>
                    </tr>
                </thead>
                <tbody>
                    {% for mouvement in mouvements_recents %}
                    <tr>
                        <td>{{ mouvement.date_mouvement|date:"d/m/Y H:i" }}</td>
                        <td>
                            <a href="{% url 'detail_produit' mouvement.poisson.id %}" style="color: var(--primary-color); text-decoration: none;">
                                {{ mouvement.poisson.type }}
                            </a>
                        </td>
                        <td>
                            <span class="status-badge 
                                {% if mouvement.type_mouvement == 'ENTREE' %}success
                                {% elif mouvement.type_mouvement == 'SORTIE' %}danger
                                {% elif mouvement.type_mouvement == 'AJUSTEMENT' %}warning
                                {% else %}info{% endif %}">
                                {{ mouvement.get_type_mouvement_display }}
                            </span>
                        </td>
                        <td>{{ mouvement.quantite }} {{ mouvement.poisson.unite_mesure }}</td>
                        <td>{{ mouvement.utilisateur.username }}</td>
                        <td>{{ mouvement.motif|truncatechars:30|default:"-" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
            <i class="fas fa-clock" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
            <p>Aucun mouvement récent</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Données initiales du graphique
let chartData = {{ chart_data|safe }};
let stockChart;

// Initialiser le graphique
function initChart(data) {
    const ctx = document.getElementById('stockChart').getContext('2d');
    
    const labels = Object.keys(data).sort();
    const entreeData = labels.map(date => data[date].ENTREE);
    const sortieData = labels.map(date => data[date].SORTIE);
    const ajustementData = labels.map(date => data[date].AJUSTEMENT);
    const retourData = labels.map(date => data[date].RETOUR);
    
    if (stockChart) {
        stockChart.destroy();
    }
    
    stockChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels.map(date => new Date(date).toLocaleDateString('fr-FR')),
            datasets: [{
                label: 'Entrées',
                data: entreeData,
                borderColor: '#059669',
                backgroundColor: 'rgba(5, 150, 105, 0.1)',
                tension: 0.4
            }, {
                label: 'Sorties',
                data: sortieData,
                borderColor: '#dc2626',
                backgroundColor: 'rgba(220, 38, 38, 0.1)',
                tension: 0.4
            }, {
                label: 'Ajustements',
                data: ajustementData,
                borderColor: '#d97706',
                backgroundColor: 'rgba(217, 119, 6, 0.1)',
                tension: 0.4
            }, {
                label: 'Retours',
                data: retourData,
                borderColor: '#0ea5e9',
                backgroundColor: 'rgba(14, 165, 233, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    position: 'top'
                }
            }
        }
    });
}

// Charger le graphique initial
initChart(chartData);

// Gérer le changement de période
document.getElementById('periodSelect').addEventListener('change', function() {
    const periode = this.value;
    
    fetch(`{% url 'api_stock_data' %}?periode=${periode}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                initChart(data.data);
            }
        })
        .catch(error => console.error('Erreur:', error));
});
</script>
{% endblock %}
